<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG Monitor â€” ç¾¤èŠç›‘æ§ä»ªè¡¨ç›˜</title>
    <meta name="description" content="Telegram ç¾¤èŠç›‘æ§ä¸æ™ºèƒ½åˆ†æä»ªè¡¨ç›˜ V2">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a1a;
            --bg-secondary: #111128;
            --bg-card: rgba(20, 20, 50, 0.7);
            --bg-sidebar: #0d0d24;
            --bg-hover: rgba(79, 195, 247, 0.08);
            --accent: #4fc3f7;
            --accent2: #b388ff;
            --accent3: #f48fb1;
            --accent4: #69f0ae;
            --accent5: #ffb74d;
            --accent6: #ef5350;
            --text: #e8eaf6;
            --text2: #9fa8da;
            --text3: #5c6bc0;
            --border: rgba(255, 255, 255, 0.06);
            --glass: rgba(255, 255, 255, 0.03);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --r: 14px;
            --sidebar-w: 220px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 30%, rgba(79, 195, 247, 0.04) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(179, 136, 255, 0.04) 0%, transparent 50%);
            z-index: -1
        }

        /* â”€â”€â”€ ä¾§è¾¹æ  â”€â”€â”€ */
        .sidebar {
            width: var(--sidebar-w);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 200;
            display: flex;
            flex-direction: column;
            transition: transform .3s
        }

        .sidebar-brand {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px
        }

        .sidebar-brand h1 {
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .sidebar-brand span {
            font-size: 20px
        }

        .sidebar-nav {
            flex: 1;
            padding: 12px 8px;
            overflow-y: auto
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: var(--text2);
            transition: all .2s;
            margin-bottom: 2px
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text)
        }

        .nav-item.active {
            background: rgba(79, 195, 247, 0.12);
            color: var(--accent);
            font-weight: 600
        }

        .nav-item .icon {
            font-size: 16px;
            width: 20px;
            text-align: center
        }

        .nav-divider {
            height: 1px;
            background: var(--border);
            margin: 10px 14px
        }

        .sidebar-footer {
            padding: 14px;
            border-top: 1px solid var(--border)
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--accent4)
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--accent4);
            border-radius: 50%;
            animation: pulse 2s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .3
            }
        }

        /* â”€â”€â”€ ä¸»åŒºåŸŸ â”€â”€â”€ */
        .main {
            margin-left: var(--sidebar-w);
            flex: 1;
            min-height: 100vh
        }

        .topbar {
            padding: 16px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            background: rgba(10, 10, 26, 0.8);
            position: sticky;
            top: 0;
            z-index: 100
        }

        .topbar h2 {
            font-size: 18px;
            font-weight: 600
        }

        .topbar-actions {
            display: flex;
            gap: 8px
        }

        .btn {
            padding: 7px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text2);
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all .2s;
            display: flex;
            align-items: center;
            gap: 4px
        }

        .btn:hover {
            background: var(--bg-hover);
            color: var(--text)
        }

        .btn-accent {
            border-color: rgba(79, 195, 247, .3);
            color: var(--accent);
            background: rgba(79, 195, 247, .08)
        }

        .btn-accent:hover {
            background: rgba(79, 195, 247, .15)
        }

        .content {
            padding: 24px 30px
        }

        /* â”€â”€â”€ é¡µé¢æ ·å¼ â”€â”€â”€ */
        .page {
            display: none
        }

        .page.active {
            display: block
        }

        /* â”€â”€â”€ å¡ç‰‡ â”€â”€â”€ */
        .card {
            background: var(--bg-card);
            border-radius: var(--r);
            border: 1px solid var(--border);
            backdrop-filter: blur(12px);
            overflow: hidden;
            margin-bottom: 20px
        }

        .card-h {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .card-h h3 {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .card-b {
            padding: 16px 20px
        }

        /* â”€â”€â”€ ç½‘æ ¼ â”€â”€â”€ */
        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
            margin-bottom: 20px
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px
        }

        .grid-23 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px
        }

        .grid-32 {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px
        }

        /* â”€â”€â”€ ç»Ÿè®¡å¡ â”€â”€â”€ */
        .s-card {
            background: var(--bg-card);
            border-radius: var(--r);
            padding: 18px 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: transform .25s
        }

        .s-card:hover {
            transform: translateY(-3px)
        }

        .s-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px
        }

        .s-card:nth-child(1)::before {
            background: linear-gradient(90deg, var(--accent), var(--accent2))
        }

        .s-card:nth-child(2)::before {
            background: linear-gradient(90deg, var(--accent4), #00c853)
        }

        .s-card:nth-child(3)::before {
            background: linear-gradient(90deg, var(--accent5), #ff9100)
        }

        .s-card:nth-child(4)::before {
            background: linear-gradient(90deg, var(--accent3), var(--accent2))
        }

        .s-card:nth-child(5)::before {
            background: linear-gradient(90deg, var(--accent2), var(--accent))
        }

        .s-card .ic {
            font-size: 22px;
            margin-bottom: 8px
        }

        .s-card .val {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -1px
        }

        .s-card .lbl {
            font-size: 12px;
            color: var(--text2);
            margin-top: 2px
        }

        /* â”€â”€â”€ æ¶ˆæ¯åˆ—è¡¨ â”€â”€â”€ */
        .msg-list {
            max-height: 500px;
            overflow-y: auto
        }

        .msg-list::-webkit-scrollbar {
            width: 3px
        }

        .msg-list::-webkit-scrollbar-track {
            background: transparent
        }

        .msg-list::-webkit-scrollbar-thumb {
            background: var(--text3);
            border-radius: 2px
        }

        .msg {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            transition: background .15s
        }

        .msg:hover {
            background: var(--glass)
        }

        .msg:last-child {
            border-bottom: none
        }

        .msg-top {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 3px;
            flex-wrap: wrap
        }

        .msg-time {
            font-size: 10px;
            color: var(--text3);
            font-family: monospace
        }

        .msg-grp {
            font-size: 10px;
            color: var(--accent2);
            padding: 1px 6px;
            background: rgba(179, 136, 255, .1);
            border-radius: 4px
        }

        .msg-sender {
            font-size: 11px;
            color: var(--accent);
            font-weight: 500
        }

        .msg-txt {
            font-size: 12px;
            color: var(--text2);
            line-height: 1.5;
            word-break: break-word
        }

        .msg-alert {
            display: inline-block;
            font-size: 10px;
            padding: 1px 6px;
            background: rgba(239, 83, 80, .12);
            color: var(--accent6);
            border-radius: 4px;
            margin-left: 4px
        }

        .hl {
            color: var(--accent5);
            font-weight: 600;
            background: rgba(255, 183, 77, .1);
            padding: 0 2px;
            border-radius: 2px
        }

        /* â”€â”€â”€ ç¾¤ç»„åˆ—è¡¨ â”€â”€â”€ */
        .grp {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background .15s
        }

        .grp:hover {
            background: var(--glass)
        }

        .grp:last-child {
            border-bottom: none
        }

        .grp-name {
            font-size: 13px;
            font-weight: 500;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .grp-cnt {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent)
        }

        .grp-sub {
            font-size: 10px;
            color: var(--text3)
        }

        .grp-bar {
            height: 3px;
            background: rgba(79, 195, 247, .1);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden
        }

        .grp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            border-radius: 2px;
            transition: width .8s
        }

        /* â”€â”€â”€ çƒ­åŠ›å›¾ â”€â”€â”€ */
        .heatmap {
            display: grid;
            grid-template-columns: 40px repeat(24, 1fr);
            gap: 2px
        }

        .hm-label {
            font-size: 10px;
            color: var(--text3);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px
        }

        .hm-cell {
            aspect-ratio: 1;
            border-radius: 3px;
            transition: all .2s;
            cursor: pointer;
            position: relative
        }

        .hm-cell:hover {
            transform: scale(1.3);
            z-index: 1
        }

        .hm-hour {
            font-size: 9px;
            color: var(--text3);
            text-align: center;
            padding-top: 4px
        }

        /* â”€â”€â”€ æœç´¢ â”€â”€â”€ */
        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px
        }

        .search-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            transition: border-color .2s
        }

        .search-input:focus {
            border-color: var(--accent)
        }

        .search-input::placeholder {
            color: var(--text3)
        }

        .search-btn {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border: none;
            color: #fff;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            font-weight: 500
        }

        .search-btn:hover {
            opacity: .85
        }

        /* â”€â”€â”€ ç”¨æˆ· â”€â”€â”€ */
        .usr {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border)
        }

        .usr:last-child {
            border-bottom: none
        }

        .usr-rk {
            font-size: 16px;
            width: 28px;
            text-align: center
        }

        .usr-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500
        }

        .usr-cnt {
            font-size: 13px;
            color: var(--accent);
            font-weight: 600
        }

        /* â”€â”€â”€ é“¾æ¥ â”€â”€â”€ */
        .lnk {
            padding: 8px 0;
            border-bottom: 1px solid var(--border)
        }

        .lnk:last-child {
            border-bottom: none
        }

        .lnk a {
            font-size: 12px;
            color: var(--accent);
            text-decoration: none;
            word-break: break-all
        }

        .lnk a:hover {
            text-decoration: underline
        }

        .lnk-meta {
            font-size: 10px;
            color: var(--text3);
            margin-top: 3px
        }

        /* â”€â”€â”€ å‘Šè­¦æ ‡ç­¾ â”€â”€â”€ */
        .kw-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px
        }

        .kw-tag {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 6px;
            background: rgba(239, 83, 80, .1);
            color: var(--accent6);
            border: 1px solid rgba(239, 83, 80, .2);
            cursor: pointer;
            transition: all .2s
        }

        .kw-tag:hover {
            background: rgba(239, 83, 80, .2)
        }

        /* â”€â”€â”€ Loading â”€â”€â”€ */
        .loading {
            text-align: center;
            padding: 30px;
            color: var(--text3)
        }

        .spin {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: sp .7s linear infinite
        }

        @keyframes sp {
            to {
                transform: rotate(360deg)
            }
        }

        /* â”€â”€â”€ è¿”å›æŒ‰é’® â”€â”€â”€ */
        .back-btn {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text2);
            margin-bottom: 16px
        }

        .back-btn:hover {
            color: var(--text)
        }

        /* â”€â”€â”€ æ—¶é—´é€‰æ‹©å™¨ â”€â”€â”€ */
        .time-sel {
            display: flex;
            gap: 3px
        }

        .t-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text3);
            padding: 3px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-family: inherit;
            transition: all .2s
        }

        .t-btn.on,
        .t-btn:hover {
            background: rgba(79, 195, 247, .12);
            color: var(--accent);
            border-color: rgba(79, 195, 247, .3)
        }

        /* â”€â”€â”€ å“åº”å¼ â”€â”€â”€ */
        @media(max-width:900px) {
            .sidebar {
                transform: translateX(-100%)
            }

            .main {
                margin-left: 0
            }

            .grid-5 {
                grid-template-columns: repeat(2, 1fr)
            }

            .grid-2,
            .grid-23,
            .grid-32 {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar">
        <div class="sidebar-brand"><span>ğŸ”</span>
            <h1>TG Monitor</h1>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" onclick="showPage('overview')"><span class="icon">ğŸ“Š</span>æ¦‚è§ˆ</div>
            <div class="nav-item" onclick="showPage('messages')"><span class="icon">ğŸ’¬</span>æ¶ˆæ¯æµ</div>
            <div class="nav-item" onclick="showPage('groups')"><span class="icon">ğŸ“Œ</span>ç¾¤ç»„</div>
            <div class="nav-item" onclick="showPage('search')"><span class="icon">ğŸ”</span>æœç´¢</div>
            <div class="nav-divider"></div>
            <div class="nav-item" onclick="showPage('links')"><span class="icon">ğŸ”—</span>é“¾æ¥</div>
            <div class="nav-item" onclick="showPage('alerts')"><span class="icon">ğŸš¨</span>å‘Šè­¦</div>
            <div class="nav-item" onclick="showPage('heatmap')"><span class="icon">ğŸ—“ï¸</span>çƒ­åŠ›å›¾</div>
            <div class="nav-item" onclick="showPage('summary')"><span class="icon">ğŸ“</span>AI æ‘˜è¦</div>
            <div class="nav-divider"></div>
            <div class="nav-item" onclick="exportCSV()"><span class="icon">ğŸ“¥</span>å¯¼å‡º CSV</div>
        </nav>
        <div class="sidebar-footer">
            <div style="font-size:11px;color:var(--text3);margin-bottom:6px" id="sidebar-stats">â³ åŠ è½½ä¸­...</div>
            <div class="status">
                <div class="status-dot"></div><span id="footer-status">ç›‘æ§ä¸­</span>
            </div>
        </div>
    </aside>

    <!-- ä¸»åŒºåŸŸ -->
    <div class="main">
        <div class="topbar">
            <h2 id="page-title">ğŸ“Š æ¦‚è§ˆ</h2>
            <div class="topbar-actions">
                <button class="btn" onclick="refreshAll()">ğŸ”„ åˆ·æ–°</button>
                <button class="btn btn-accent" id="auto-refresh-btn" onclick="toggleAutoRefresh()">â± è‡ªåŠ¨åˆ·æ–°: å¼€</button>
            </div>
        </div>
        <div class="content">

            <!-- â•â•â• æ¦‚è§ˆé¡µ â•â•â• -->
            <div class="page active" id="page-overview">
                <div class="grid-5" id="stat-cards">
                    <div class="s-card">
                        <div class="ic">ğŸ’¬</div>
                        <div class="val" id="v-total">â€”</div>
                        <div class="lbl">æ€»æ¶ˆæ¯é‡</div>
                    </div>
                    <div class="s-card">
                        <div class="ic">âš¡</div>
                        <div class="val" id="v-1h">â€”</div>
                        <div class="lbl">æœ€è¿‘ 1 å°æ—¶</div>
                    </div>
                    <div class="s-card">
                        <div class="ic">ğŸ“ˆ</div>
                        <div class="val" id="v-24h">â€”</div>
                        <div class="lbl">æœ€è¿‘ 24 å°æ—¶</div>
                    </div>
                    <div class="s-card">
                        <div class="ic">ğŸ“…</div>
                        <div class="val" id="v-7d">â€”</div>
                        <div class="lbl">æœ€è¿‘ 7 å¤©</div>
                    </div>
                    <div class="s-card">
                        <div class="ic">ğŸ“Œ</div>
                        <div class="val" id="v-grp">â€”</div>
                        <div class="lbl">ç›‘æ§ç¾¤ç»„</div>
                    </div>
                </div>
                <div class="grid-23">
                    <div class="card">
                        <div class="card-h">
                            <h3>ğŸ“ˆ æ¶ˆæ¯è¶‹åŠ¿</h3>
                            <div class="time-sel">
                                <button class="t-btn" onclick="loadTrends(24)" data-h="24">24h</button>
                                <button class="t-btn on" onclick="loadTrends(72)" data-h="72">3å¤©</button>
                                <button class="t-btn" onclick="loadTrends(168)" data-h="168">7å¤©</button>
                            </div>
                        </div>
                        <div class="card-b"><canvas id="trendChart" height="220"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="card-h">
                            <h3>ğŸ“Œ ç¾¤ç»„æ´»è·ƒåº¦ (24h)</h3>
                        </div>
                        <div class="card-b" id="ov-groups" style="max-height:340px;overflow-y:auto">
                            <div class="loading">
                                <div class="spin"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="card">
                        <div class="card-h">
                            <h3>ğŸ“Š ä»Šå¤© vs æ˜¨å¤©</h3>
                        </div>
                        <div class="card-b"><canvas id="compChart" height="180"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="card-h">
                            <h3>ğŸ† æœ€æ´»è·ƒç”¨æˆ· (24h)</h3>
                        </div>
                        <div class="card-b" id="ov-users">
                            <div class="loading">
                                <div class="spin"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• æ¶ˆæ¯æµé¡µ â•â•â• -->
            <div class="page" id="page-messages">
                <div class="card">
                    <div class="card-h">
                        <h3>ğŸ’¬ å®æ—¶æ¶ˆæ¯æµ</h3><span style="font-size:11px;color:var(--text3)" id="msg-count"></span>
                    </div>
                    <div class="card-b">
                        <div class="msg-list" id="msg-feed" style="max-height:calc(100vh - 200px)">
                            <div class="loading">
                                <div class="spin"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• ç¾¤ç»„é¡µ â•â•â• -->
            <div class="page" id="page-groups">
                <div id="groups-main">
                    <div class="card">
                        <div class="card-h">
                            <h3>ğŸ“Œ æ‰€æœ‰ç¾¤ç»„</h3>
                        </div>
                        <div class="card-b" id="all-groups">
                            <div class="loading">
                                <div class="spin"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="group-detail" style="display:none">
                    <div class="back-btn" onclick="closeGroupDetail()">â† è¿”å›ç¾¤ç»„åˆ—è¡¨</div>
                    <div id="gd-header"></div>
                    <div class="grid-2" style="margin-bottom:20px">
                        <div class="card">
                            <div class="card-h">
                                <h3>ğŸ“ˆ æ¶ˆæ¯è¶‹åŠ¿</h3>
                            </div>
                            <div class="card-b"><canvas id="gdChart" height="180"></canvas></div>
                        </div>
                        <div class="card">
                            <div class="card-h">
                                <h3>ğŸ† æ´»è·ƒç”¨æˆ·</h3>
                            </div>
                            <div class="card-b" id="gd-users"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-h">
                            <h3>ğŸ’¬ æœ€æ–°æ¶ˆæ¯</h3>
                        </div>
                        <div class="card-b">
                            <div class="msg-list" id="gd-msgs" style="max-height:400px"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• æœç´¢é¡µ â•â•â• -->
            <div class="page" id="page-search">
                <div class="card">
                    <div class="card-h">
                        <h3>ğŸ” å…¨æ–‡æœç´¢</h3>
                    </div>
                    <div class="card-b">
                        <div class="search-bar">
                            <input type="text" class="search-input" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯æœç´¢æ¶ˆæ¯..."
                                onkeydown="if(event.key==='Enter')doSearch()">
                            <button class="search-btn" onclick="doSearch()">æœç´¢</button>
                        </div>
                        <div class="msg-list" id="search-results">
                            <div style="color:var(--text3);font-size:12px;text-align:center;padding:30px">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• é“¾æ¥é¡µ â•â•â• -->
            <div class="page" id="page-links">
                <div class="card">
                    <div class="card-h">
                        <h3>ğŸ”— æœ€æ–°é“¾æ¥</h3>
                    </div>
                    <div class="card-b">
                        <div class="msg-list" id="all-links">
                            <div class="loading">
                                <div class="spin"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• å‘Šè­¦é¡µ â•â•â• -->
            <div class="page" id="page-alerts">
                <div class="card">
                    <div class="card-h">
                        <h3>ğŸš¨ å‘Šè­¦é…ç½®</h3>
                    </div>
                    <div class="card-b" id="alert-cfg">
                        <div class="loading">
                            <div class="spin"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-h">
                        <h3>ğŸ”” å«å‘Šè­¦å…³é”®è¯çš„æ¶ˆæ¯</h3>
                    </div>
                    <div class="card-b">
                        <div class="msg-list" id="alert-msgs">
                            <div class="loading">
                                <div class="spin"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• çƒ­åŠ›å›¾é¡µ â•â•â• -->
            <div class="page" id="page-heatmap">
                <div class="card">
                    <div class="card-h">
                        <h3>ğŸ—“ï¸ æ´»è·ƒåº¦çƒ­åŠ›å›¾</h3><span style="font-size:11px;color:var(--text3)">æœ€è¿‘ 30 å¤© Â· æŒ‰ UTC+8 å°æ—¶åˆ†å¸ƒ</span>
                    </div>
                    <div class="card-b" id="heatmap-container">
                        <div class="loading">
                            <div class="spin"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• AI æ‘˜è¦é¡µ â•â•â• -->
            <div class="page" id="page-summary">
                <!-- LLM çŠ¶æ€æ  -->
                <div class="card" style="margin-bottom:16px">
                    <div class="card-h">
                        <h3>ğŸ¤– AI ä»£ç†çŠ¶æ€</h3>
                        <div id="llm-status-badge"
                            style="font-size:12px;padding:4px 10px;border-radius:20px;background:rgba(255,255,255,.08)">
                            æ£€æµ‹ä¸­...</div>
                    </div>
                    <div class="card-b" id="llm-status-detail" style="font-size:12px;color:var(--text3);padding:6px 0">
                    </div>
                </div>

                <!-- ç”Ÿæˆæ§åˆ¶é¢æ¿ -->
                <div class="card" style="margin-bottom:16px">
                    <div class="card-h">
                        <h3>âš™ï¸ ç”Ÿæˆè®¾ç½®</h3>
                    </div>
                    <div class="card-b">
                        <div style="margin-bottom:14px">
                            <div style="font-size:12px;color:var(--text3);margin-bottom:8px">æ—¶é—´èŒƒå›´</div>
                            <div class="time-sel" id="sum-time-sel">
                                <button class="t-btn" onclick="setSumHours(1)" data-h="1">1h</button>
                                <button class="t-btn" onclick="setSumHours(3)" data-h="3">3h</button>
                                <button class="t-btn" onclick="setSumHours(6)" data-h="6">6h</button>
                                <button class="t-btn on" onclick="setSumHours(12)" data-h="12">12h</button>
                                <button class="t-btn" onclick="setSumHours(24)" data-h="24">24h</button>
                                <button class="t-btn" onclick="setSumHours(72)" data-h="72">3å¤©</button>
                                <button class="t-btn" onclick="setSumHours(168)" data-h="168">7å¤©</button>
                            </div>
                        </div>
                        <div style="margin-bottom:18px">
                            <div style="font-size:12px;color:var(--text3);margin-bottom:8px">æ‘˜è¦æ¨¡å¼</div>
                            <div style="display:flex;gap:10px">
                                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px">
                                    <input type="radio" name="sum-mode" value="quick" checked id="sum-mode-quick">
                                    å¿«é€Ÿæ‘˜è¦ï¼ˆå…¨éƒ¨æ¶ˆæ¯åˆå¹¶ï¼Œé€Ÿåº¦å¿«ï¼‰
                                </label>
                                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px">
                                    <input type="radio" name="sum-mode" value="per_group" id="sum-mode-pergroup">
                                    é€ç¾¤è¯¦ç»†ï¼ˆæ¯ç¾¤åˆ†æååˆå¹¶ï¼Œè´¨é‡é«˜ï¼‰
                                </label>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:12px">
                            <button class="btn btn-accent" id="sum-gen-btn" onclick="generateSummary()"
                                style="padding:10px 28px;font-size:14px">ğŸ§  ä¸€é”®ç”Ÿæˆæ‘˜è¦</button>
                            <span id="sum-msg-count" style="font-size:12px;color:var(--text3)"></span>
                        </div>
                    </div>
                </div>

                <!-- ç”Ÿæˆè¿›åº¦ -->
                <div class="card" id="sum-progress-card" style="display:none;margin-bottom:16px">
                    <div class="card-b" style="padding:16px">
                        <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px">
                            <div class="spin" style="flex-shrink:0"></div>
                            <div>
                                <div style="font-size:13px;font-weight:600;margin-bottom:4px">æ­£åœ¨ç”Ÿæˆæ‘˜è¦...</div>
                                <div id="sum-progress-text" style="font-size:12px;color:var(--text3)">åˆå§‹åŒ–ä¸­</div>
                            </div>
                        </div>
                        <!-- è¿›åº¦æ¡å®¹å™¨ -->
                        <div style="height:6px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden">
                            <div id="sum-progress-bar"
                                style="width:0%;height:100%;background:var(--accent);transition:width .3s ease"></div>
                        </div>
                    </div>
                </div>

                <!-- ç”Ÿæˆç»“æœ -->
                <div class="card" id="sum-result-card" style="display:none;margin-bottom:16px">
                    <div class="card-h">
                        <h3>ğŸ“‹ æ‘˜è¦ç»“æœ</h3>
                        <span id="sum-result-meta" style="font-size:11px;color:var(--text3)"></span>
                    </div>
                    <div class="card-b" id="sum-result-content"
                        style="white-space:pre-wrap;font-size:13px;line-height:1.7;max-height:600px;overflow-y:auto">
                    </div>
                </div>

                <!-- å†å²æ‘˜è¦ -->
                <div class="card">
                    <div class="card-h">
                        <h3>ğŸ“œ å†å²æ‘˜è¦</h3>
                        <button class="btn" onclick="loadSummaryHistory()"
                            style="font-size:11px;padding:4px 10px">åˆ·æ–°</button>
                    </div>
                    <div class="card-b" id="sum-history" style="max-height:400px;overflow-y:auto">
                        <div class="loading">
                            <div class="spin"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // â”€â”€â”€ å·¥å…· â”€â”€â”€
        const FN = n => n >= 10000 ? (n / 10000).toFixed(1) + 'ä¸‡' : n >= 1000 ? (n / 1000).toFixed(1) + 'k' : String(n);
        const BJ = iso => { if (!iso) return '?'; try { let s = String(iso); if (!s.includes('Z') && !s.includes('+') && !(s.length > 10 && s.lastIndexOf('-') > 10)) s += 'Z'; const d = new Date(s); if (isNaN(d.getTime())) return iso.slice(0, 16).replace('T', ' '); return d.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) } catch { return String(iso).slice(0, 16).replace('T', ' ') } };
        const E = s => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        // è¿‡æ»¤ t.me / telegram / telegra.ph / telegram.dog / tg:// é“¾æ¥ï¼ˆF4 ä¿®å¤ï¼šä¸åç«¯ TG_BLOCK_DOMAINS ä¿æŒä¸€è‡´ï¼Œå…± 5 ä¸ªåŸŸåï¼‰
        const STRIP_TG = s => (s || '').replace(/https?:\/\/(?:t\.me|telegram\.me|telegram\.org|telegra\.ph|telegram\.dog)\S*/gi, '').replace(/(?:^|\s)t\.me\/\S*/gi, ' ').replace(/tg:\/\/\S*/gi, '').replace(/\s{2,}/g, ' ').trim();
        const RK = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ'];
        const DOW = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        let autoRefresh = true, refreshTimer = null;

        // â”€â”€â”€ é¡µé¢è·¯ç”± â”€â”€â”€
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const page = document.getElementById('page-' + id);
            if (page) page.classList.add('active');
            const titles = { overview: 'ğŸ“Š æ¦‚è§ˆ', messages: 'ğŸ’¬ æ¶ˆæ¯æµ', groups: 'ğŸ“Œ ç¾¤ç»„', search: 'ğŸ” æœç´¢', links: 'ğŸ”— é“¾æ¥', alerts: 'ğŸš¨ å‘Šè­¦', heatmap: 'ğŸ—“ï¸ çƒ­åŠ›å›¾', summary: 'ğŸ“ AI æ‘˜è¦' };
            document.getElementById('page-title').textContent = titles[id] || id;
            document.querySelectorAll('.nav-item').forEach(n => { if (n.textContent.trim().includes(titles[id]?.slice(2) || id)) n.classList.add('active') });
            // åŠ è½½é¡µé¢æ•°æ®
            const loaders = { overview: loadOverviewPage, messages: loadMessages, groups: loadGroupsPage, links: loadLinksPage, alerts: loadAlertsPage, heatmap: loadHeatmap, summary: loadSummaryPage };
            if (loaders[id]) loaders[id]();
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            document.getElementById('auto-refresh-btn').textContent = autoRefresh ? 'â± è‡ªåŠ¨åˆ·æ–°: å¼€' : 'â± è‡ªåŠ¨åˆ·æ–°: å…³';
            if (autoRefresh) startAutoRefresh(); else if (refreshTimer) clearInterval(refreshTimer);
        }
        function startAutoRefresh() { if (refreshTimer) clearInterval(refreshTimer); refreshTimer = setInterval(refreshAll, 30000) }

        // â”€â”€â”€ æ¦‚è§ˆ â”€â”€â”€
        async function loadOverviewPage() { loadOverview(); loadTrends(72); loadOvGroups(); loadComparison(); loadOvUsers() }

        async function loadOverview() {
            try {
                const r = await fetch('/api/overview'); const d = await r.json();
                document.getElementById('v-total').textContent = FN(d.total_messages);
                document.getElementById('v-1h').textContent = FN(d.last_1h);
                document.getElementById('v-24h').textContent = FN(d.last_24h);
                document.getElementById('v-7d').textContent = FN(d.last_7d);
                document.getElementById('v-grp').textContent = d.group_count;
            } catch (e) { console.error(e) }
        }

        let trendChart = null;
        async function loadTrends(h = 72) {
            document.querySelectorAll('.t-btn').forEach(b => b.classList.toggle('on', parseInt(b.dataset.h) === h));
            try {
                const r = await fetch(`/api/trends?hours=${h}`); const d = await r.json();
                const labels = d.data.map(p => { const dt = new Date(p.hour + 'Z'); return dt.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }) });
                const vals = d.data.map(p => p.count);
                if (trendChart) trendChart.destroy();
                const ctx = document.getElementById('trendChart').getContext('2d');
                const g = ctx.createLinearGradient(0, 0, 0, 220); g.addColorStop(0, 'rgba(79,195,247,.25)'); g.addColorStop(1, 'rgba(79,195,247,0)');
                trendChart = new Chart(ctx, {
                    type: 'line', data: { labels, datasets: [{ data: vals, borderColor: '#4fc3f7', backgroundColor: g, fill: true, tension: .4, borderWidth: 2, pointRadius: 0, pointHoverRadius: 3 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1a1a2e', borderColor: 'rgba(255,255,255,.1)', borderWidth: 1, padding: 8, cornerRadius: 6 } },
                        scales: { x: { grid: { color: 'rgba(255,255,255,.02)' }, ticks: { color: '#5c6bc0', font: { size: 9 }, maxRotation: 0, maxTicksLimit: 10 } }, y: { grid: { color: 'rgba(255,255,255,.02)' }, ticks: { color: '#5c6bc0', font: { size: 9 } }, beginAtZero: true } }, interaction: { intersect: false, mode: 'index' }
                    }
                });
            } catch (e) { console.error(e) }
        }

        let compChart = null;
        async function loadComparison() {
            try {
                const r = await fetch('/api/comparison'); const d = await r.json();
                const hours = Array.from({ length: 24 }, (_, i) => String(i).padStart(2, '0') + ':00');
                const todayMap = Object.fromEntries((d.today || []).map(x => [x.hour, x.count]));
                const ydayMap = Object.fromEntries((d.yesterday || []).map(x => [x.hour, x.count]));
                const todayData = hours.map((_, i) => todayMap[i] || 0);
                const ydayData = hours.map((_, i) => ydayMap[i] || 0);
                if (compChart) compChart.destroy();
                const ctx = document.getElementById('compChart').getContext('2d');
                compChart = new Chart(ctx, {
                    type: 'bar', data: {
                        labels: hours, datasets: [
                            { label: 'ä»Šå¤©', data: todayData, backgroundColor: 'rgba(79,195,247,.6)', borderRadius: 3, barPercentage: .4 },
                            { label: 'æ˜¨å¤©', data: ydayData, backgroundColor: 'rgba(179,136,255,.3)', borderRadius: 3, barPercentage: .4 }
                        ]
                    }, options: {
                        responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#9fa8da', font: { size: 10 } } } },
                        scales: { x: { grid: { display: false }, ticks: { color: '#5c6bc0', font: { size: 9 }, maxTicksLimit: 12 } }, y: { grid: { color: 'rgba(255,255,255,.02)' }, ticks: { color: '#5c6bc0', font: { size: 9 } }, beginAtZero: true } }
                    }
                });
            } catch (e) { console.error(e) }
        }

        async function loadOvGroups() {
            try {
                const r = await fetch('/api/groups?hours=24'); const d = await r.json(); const el = document.getElementById('ov-groups');
                if (!d.data.length) { el.innerHTML = '<div style="color:var(--text3);text-align:center;padding:20px">æš‚æ— æ•°æ®</div>'; return }
                const mx = Math.max(...d.data.map(g => g.message_count));
                el.innerHTML = d.data.map(g => `<div class="grp" onclick="openGroupDetail(${g.group_id})"><div><div class="grp-name">${E(g.title || 'ç¾¤ç»„' + g.group_id)}</div><div class="grp-bar"><div class="grp-bar-fill" style="width:${(g.message_count / mx * 100).toFixed(1)}%"></div></div></div><div style="text-align:right"><div class="grp-cnt">${g.message_count}</div><div class="grp-sub">${g.active_users} äºº</div></div></div>`).join('');
            } catch (e) { console.error(e) }
        }

        async function loadOvUsers() {
            try {
                const r = await fetch('/api/top_senders?hours=24&limit=10'); const d = await r.json(); const el = document.getElementById('ov-users');
                if (!d.data.length) { el.innerHTML = '<div style="color:var(--text3);text-align:center;padding:20px">æš‚æ— </div>'; return }
                el.innerHTML = d.data.map((u, i) => `<div class="usr"><div class="usr-rk">${RK[i] || (i + 1)}</div><div class="usr-name">${E(u.sender_name || '?')}</div><div class="usr-cnt">${u.msg_count} æ¡</div></div>`).join('');
            } catch (e) { console.error(e) }
        }

        // â”€â”€â”€ æ¶ˆæ¯æµ â”€â”€â”€
        async function loadMessages() {
            const el = document.getElementById('msg-feed'); el.innerHTML = '<div class="loading"><div class="spin"></div></div>';
            try {
                const r = await fetch('/api/recent_messages?limit=200'); const d = await r.json();
                document.getElementById('msg-count').textContent = `${d.data.length} æ¡æ¶ˆæ¯`;
                el.innerHTML = d.data.map(m => {
                    const alerts = (m.alert_keywords || []).map(k => `<span class="msg-alert">ğŸ”‘ ${E(k)}</span>`).join('');
                    return `<div class="msg"><div class="msg-top"><span class="msg-time">${BJ(m.date)}</span><span class="msg-grp">${E(m.group_title)}</span><span class="msg-sender">${E(m.sender_name || '?')}</span>${alerts}</div><div class="msg-txt">${E(STRIP_TG(m.text || '').slice(0, 300))}</div></div>`
                }).join('') || '<div style="color:var(--text3);text-align:center;padding:30px">æš‚æ— æ¶ˆæ¯</div>';
            } catch (e) { el.innerHTML = '<div style="color:var(--accent6)">åŠ è½½å¤±è´¥</div>' }
        }

        // â”€â”€â”€ ç¾¤ç»„ â”€â”€â”€
        async function loadGroupsPage() {
            const el = document.getElementById('all-groups'); el.innerHTML = '<div class="loading"><div class="spin"></div></div>';
            document.getElementById('groups-main').style.display = 'block';
            document.getElementById('group-detail').style.display = 'none';
            try {
                const r = await fetch('/api/groups?hours=24'); const d = await r.json();
                if (!d.data.length) { el.innerHTML = '<div style="color:var(--text3);text-align:center;padding:20px">æš‚æ— ç¾¤ç»„</div>'; return }
                const mx = Math.max(...d.data.map(g => g.message_count));
                el.innerHTML = d.data.map(g => `<div class="grp" onclick="openGroupDetail(${g.group_id})"><div><div class="grp-name">${E(g.title || 'ç¾¤ç»„' + g.group_id)}</div><div class="grp-bar"><div class="grp-bar-fill" style="width:${(g.message_count / mx * 100).toFixed(1)}%"></div></div></div><div style="text-align:right"><div class="grp-cnt">${g.message_count}</div><div class="grp-sub">${g.active_users} äºº</div></div></div>`).join('');
            } catch (e) { console.error(e) }
        }

        let gdChart = null;
        async function openGroupDetail(gid) {
            document.getElementById('groups-main').style.display = 'none';
            document.getElementById('group-detail').style.display = 'block';
            try {
                const r = await fetch(`/api/groups/${gid}?hours=24`); const d = await r.json();
                // å¤´éƒ¨
                const info = d.info || {};
                document.getElementById('gd-header').innerHTML = `<div class="grid-5" style="margin-bottom:16px"><div class="s-card"><div class="ic">ğŸ“Œ</div><div class="val" style="font-size:18px">${E(info.title || 'ç¾¤ç»„')}</div><div class="lbl">ID: ${gid}</div></div><div class="s-card"><div class="ic">ğŸ’¬</div><div class="val">${d.messages.length}</div><div class="lbl">24h æ¶ˆæ¯</div></div><div class="s-card"><div class="ic">ğŸ‘¥</div><div class="val">${d.top_senders.length}</div><div class="lbl">æ´»è·ƒç”¨æˆ·</div></div></div>`;
                // è¶‹åŠ¿
                if (gdChart) gdChart.destroy();
                const ctx = document.getElementById('gdChart').getContext('2d');
                const g = ctx.createLinearGradient(0, 0, 0, 180); g.addColorStop(0, 'rgba(179,136,255,.25)'); g.addColorStop(1, 'rgba(179,136,255,0)');
                gdChart = new Chart(ctx, {
                    type: 'line', data: { labels: d.trends.map(t => BJ(t.hour)), datasets: [{ data: d.trends.map(t => t.count), borderColor: '#b388ff', backgroundColor: g, fill: true, tension: .4, borderWidth: 2, pointRadius: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(255,255,255,.02)' }, ticks: { color: '#5c6bc0', font: { size: 9 }, maxTicksLimit: 10, maxRotation: 0 } }, y: { grid: { color: 'rgba(255,255,255,.02)' }, ticks: { color: '#5c6bc0', font: { size: 9 } }, beginAtZero: true } } }
                });
                // ç”¨æˆ·
                document.getElementById('gd-users').innerHTML = d.top_senders.map((u, i) => `<div class="usr"><div class="usr-rk">${RK[i] || (i + 1)}</div><div class="usr-name">${E(u.sender_name || '?')}</div><div class="usr-cnt">${u.msg_count} æ¡</div></div>`).join('') || '<div style="color:var(--text3)">æš‚æ— </div>';
                // æ¶ˆæ¯
                document.getElementById('gd-msgs').innerHTML = d.messages.map(m => `<div class="msg"><div class="msg-top"><span class="msg-time">${BJ(m.date)}</span><span class="msg-sender">${E(m.sender_name || '?')}</span></div><div class="msg-txt">${E(STRIP_TG(m.text || '').slice(0, 300))}</div></div>`).join('') || 'æš‚æ— æ¶ˆæ¯';
            } catch (e) { console.error(e) }
        }
        function closeGroupDetail() { document.getElementById('groups-main').style.display = 'block'; document.getElementById('group-detail').style.display = 'none' }

        // â”€â”€â”€ æœç´¢ â”€â”€â”€
        async function doSearch() {
            const q = document.getElementById('searchInput').value.trim(); if (!q) return;
            const el = document.getElementById('search-results'); el.innerHTML = '<div class="loading"><div class="spin"></div></div>';
            try {
                const r = await fetch(`/api/search?q=${encodeURIComponent(q)}&limit=50`); const d = await r.json();
                if (!d.data.length) { el.innerHTML = `<div style="color:var(--text3);text-align:center;padding:30px">æœªæ‰¾åˆ° "${E(q)}" ç›¸å…³æ¶ˆæ¯</div>`; return }
                el.innerHTML = `<div style="color:var(--accent4);font-size:11px;margin-bottom:10px">æ‰¾åˆ° ${d.total} æ¡ç»“æœ</div>` + d.data.map(m => {
                    const txt = E(STRIP_TG(m.text || '').slice(0, 300)); const hl = txt.replace(new RegExp(E(q), 'gi'), x => `<span class="hl">${x}</span>`);
                    return `<div class="msg"><div class="msg-top"><span class="msg-time">${BJ(m.date)}</span><span class="msg-grp">${E(m.group_title || '?')}</span><span class="msg-sender">${E(m.sender_name || '?')}</span></div><div class="msg-txt">${hl}</div></div>`
                }).join('');
            } catch (e) { el.innerHTML = '<div style="color:var(--accent6)">æœç´¢å¤±è´¥</div>' }
        }

        // â”€â”€â”€ é“¾æ¥ â”€â”€â”€
        async function loadLinksPage() {
            const el = document.getElementById('all-links'); el.innerHTML = '<div class="loading"><div class="spin"></div></div>';
            try {
                const r = await fetch('/api/links?limit=50'); const d = await r.json();
                // å‰ç«¯ä¸‰é‡è¿‡æ»¤ï¼šæ’é™¤ä»»ä½•å« t.me / telegram åŸŸåçš„é“¾æ¥
                const TG = ['t.me', 'telegram.me', 'telegram.org', 'telegra.ph'];
                const clean = d.data.filter(l => !TG.some(d => (l.url || '').toLowerCase().includes(d)));
                el.innerHTML = clean.map(l => `<div class="lnk"><a href="${E(l.url)}" target="_blank">${E(l.url.length > 90 ? l.url.slice(0, 87) + '...' : l.url)}</a><div class="lnk-meta">${BJ(l.discovered_at)} Â· ${E(l.group_title || '?')} Â· ${E(l.sender_name || '?')}</div></div>`).join('') || '<div style="color:var(--text3);text-align:center;padding:30px">æš‚æ— é“¾æ¥</div>';
            } catch (e) { console.error(e) }
        }

        // â”€â”€â”€ å‘Šè­¦ â”€â”€â”€
        async function loadAlertsPage() {
            try {
                // é…ç½®
                const r1 = await fetch('/api/alerts_config'); const d1 = await r1.json();
                const el = document.getElementById('alert-cfg');
                const st = d1.enabled ? '<span style="color:var(--accent4)">â— å·²å¯ç”¨</span>' : '<span style="color:var(--text3)">â—‹ æœªå¯ç”¨</span>';
                el.innerHTML = st + '<div class="kw-tags" style="margin-top:12px">' + d1.keywords.map(k => `<span class="kw-tag" onclick="document.getElementById('searchInput').value='${E(k)}';showPage('search');doSearch()">${E(k)}</span>`).join('') + '</div>';
                // å«å‘Šè­¦çš„æ¶ˆæ¯
                const r2 = await fetch('/api/recent_messages?limit=200'); const d2 = await r2.json();
                const alertMsgs = d2.data.filter(m => (m.alert_keywords || []).length > 0);
                const el2 = document.getElementById('alert-msgs');
                el2.innerHTML = alertMsgs.map(m => {
                    const alerts = m.alert_keywords.map(k => `<span class="msg-alert">ğŸ”‘ ${E(k)}</span>`).join('');
                    return `<div class="msg"><div class="msg-top"><span class="msg-time">${BJ(m.date)}</span><span class="msg-grp">${E(m.group_title)}</span><span class="msg-sender">${E(m.sender_name || '?')}</span>${alerts}</div><div class="msg-txt">${E(STRIP_TG(m.text || '').slice(0, 300))}</div></div>`
                }).join('') || '<div style="color:var(--text3);text-align:center;padding:30px">æš‚æ— å‘Šè­¦æ¶ˆæ¯</div>';
            } catch (e) { console.error(e) }
        }

        // â”€â”€â”€ çƒ­åŠ›å›¾ â”€â”€â”€
        async function loadHeatmap() {
            const el = document.getElementById('heatmap-container'); el.innerHTML = '<div class="loading"><div class="spin"></div></div>';
            try {
                const r = await fetch('/api/heatmap?days=30'); const d = await r.json();
                // æ„å»º 7Ã—24 çŸ©é˜µï¼ˆUTC+8 åç§»ï¼‰
                const matrix = Array.from({ length: 7 }, () => Array(24).fill(0));
                let maxVal = 1;
                d.data.forEach(p => {
                    const h = (p.hour + 8) % 24; // UTC+8
                    const dw = (p.dow + ((p.hour + 8) >= 24 ? 1 : 0)) % 7;
                    matrix[dw][h] += p.count;
                    if (matrix[dw][h] > maxVal) maxVal = matrix[dw][h];
                });
                // æ¸²æŸ“
                let html = '<div class="heatmap"><div></div>';
                for (let h = 0; h < 24; h++)html += `<div class="hm-hour">${h}</div>`;
                for (let d = 0; d < 7; d++) {
                    html += `<div class="hm-label">${DOW[d]}</div>`;
                    for (let h = 0; h < 24; h++) {
                        const v = matrix[d][h]; const intensity = v / maxVal;
                        const color = intensity === 0 ? 'rgba(255,255,255,.02)' : `rgba(79,195,247,${(.1 + intensity * .7).toFixed(2)})`;
                        html += `<div class="hm-cell" style="background:${color}" title="${DOW[d]} ${h}:00 â€” ${v} æ¡æ¶ˆæ¯"></div>`;
                    }
                }
                html += '</div>';
                el.innerHTML = html;
            } catch (e) { console.error(e) }
        }

        // â”€â”€â”€ å¯¼å‡º â”€â”€â”€

        // â”€â”€â”€ AI æ‘˜è¦é¡µ â”€â”€â”€
        let _sumHours = 12;
        let _sumPollTimer = null;

        async function loadSummaryPage() {
            await checkLlmStatus();
            await loadSummaryHistory();
            // æ›´æ–°æ¶ˆæ¯æ•°é¢„è§ˆ
            updateSumMsgCount();
        }

        async function updateSumMsgCount() {
            try {
                const r = await fetch(`/api/groups?hours=${_sumHours}`);
                const d = await r.json();
                const total = (d.data || []).reduce((s, g) => s + (g.message_count || 0), 0);
                const el = document.getElementById('sum-msg-count');
                if (el) el.textContent = total ? `æœ€è¿‘ ${_sumHours}h å…± ${total.toLocaleString()} æ¡æ¶ˆæ¯` : `æœ€è¿‘ ${_sumHours}h æš‚æ— æ¶ˆæ¯`;
            } catch (e) { }
        }

        function setSumHours(h) {
            _sumHours = h;
            document.querySelectorAll('#sum-time-sel .t-btn').forEach(b => {
                b.classList.toggle('on', parseInt(b.dataset.h) === h);
            });
            updateSumMsgCount();
        }

        async function checkLlmStatus() {
            const badge = document.getElementById('llm-status-badge');
            const detail = document.getElementById('llm-status-detail');
            if (!badge) return;
            badge.textContent = 'æ£€æµ‹ä¸­...';
            badge.style.background = 'rgba(255,255,255,.08)';
            try {
                const r = await fetch('/api/llm/status');
                const d = await r.json();
                if (d.ok) {
                    badge.textContent = 'âœ… åœ¨çº¿';
                    badge.style.background = 'rgba(74,222,128,.15)';
                    badge.style.color = '#4ade80';
                    if (detail) detail.textContent = `æ¨¡å‹ï¼š${d.model}   æ¥å£ï¼š${d.url}`;
                } else {
                    badge.textContent = 'âŒ ç¦»çº¿';
                    badge.style.background = 'rgba(248,113,113,.15)';
                    badge.style.color = '#f87171';
                    if (detail) detail.innerHTML = `<strong>é”™è¯¯ï¼š</strong>${E(d.error)}<br><span style="opacity:.7">æ¥å£åœ°å€ï¼š${E(d.url || 'æœªé…ç½®')}</span><br><span style="opacity:.7">è¯·ç¡®è®¤ AI ä»£ç†æœåŠ¡å·²å¯åŠ¨</span>`;
                }
            } catch (e) {
                badge.textContent = 'âš ï¸ æ£€æµ‹å¤±è´¥';
                badge.style.background = 'rgba(251,191,36,.15)';
                badge.style.color = '#fbbf24';
            }
        }

        async function generateSummary() {
            const btn = document.getElementById('sum-gen-btn');
            const progressCard = document.getElementById('sum-progress-card');
            const resultCard = document.getElementById('sum-result-card');
            const mode = document.querySelector('input[name="sum-mode"]:checked')?.value || 'quick';

            // é‡ç½®
            if (resultCard) resultCard.style.display = 'none';
            if (progressCard) progressCard.style.display = 'flex';
            btn.disabled = true;
            btn.textContent = 'â³ ç”Ÿæˆä¸­...';

            // æ¸…ç†æ—§è½®è¯¢
            if (_sumPollTimer) { clearInterval(_sumPollTimer); _sumPollTimer = null; }

            try {
                const r = await fetch(`/api/summary/generate?hours=${_sumHours}&mode=${mode}`, { method: 'POST' });
                const d = await r.json();
                if (d.task_id) {
                    _sumPollTimer = setInterval(() => pollSummaryStatus(d.task_id), 800);
                } else {
                    throw new Error(d.error || 'å¯åŠ¨å¤±è´¥');
                }
            } catch (e) {
                progressCard.style.display = 'none';
                btn.disabled = false;
                btn.textContent = 'ğŸ§  ä¸€é”®ç”Ÿæˆæ‘˜è¦';
                alert('å¯åŠ¨æ‘˜è¦ä»»åŠ¡å¤±è´¥ï¼š' + e.message);
            }
        }

        async function pollSummaryStatus(taskId) {
            try {
                const r = await fetch(`/api/summary/status/${taskId}`);
                const d = await r.json();

                const progressText = document.getElementById('sum-progress-text');
                const progressBar = document.getElementById('sum-progress-bar');
                if (progressText && d.progress) progressText.textContent = d.progress;
                if (progressBar && d.total_steps > 0) {
                    const pct = Math.min(100, Math.round((d.current_step / d.total_steps) * 100));
                    progressBar.style.width = pct + '%';
                }

                if (d.status === 'done' || d.status === 'error') {
                    clearInterval(_sumPollTimer);
                    _sumPollTimer = null;

                    const btn = document.getElementById('sum-gen-btn');
                    const progressCard = document.getElementById('sum-progress-card');
                    const resultCard = document.getElementById('sum-result-card');

                    progressCard.style.display = 'none';
                    btn.disabled = false;
                    btn.textContent = 'ğŸ§  ä¸€é”®ç”Ÿæˆæ‘˜è¦';

                    if (d.status === 'done' && d.result) {
                        resultCard.style.display = '';
                        document.getElementById('sum-result-content').textContent = d.result;
                        const meta = document.getElementById('sum-result-meta');
                        if (meta) {
                            const cnt = d.msg_count ? `åˆ†æäº† ${d.msg_count.toLocaleString()} æ¡æ¶ˆæ¯ Â· ` : '';
                            meta.textContent = `${cnt}æœ€è¿‘ ${d.hours}h Â· ${d.mode === 'per_group' ? 'é€ç¾¤è¯¦ç»†' : 'å¿«é€Ÿæ‘˜è¦'}`;
                        }
                        // åˆ·æ–°å†å²
                        await loadSummaryHistory();
                    } else {
                        resultCard.style.display = '';
                        document.getElementById('sum-result-content').innerHTML =
                            `<div style="color:#f87171;padding:12px 0">âŒ ç”Ÿæˆå¤±è´¥<br><br><strong>é”™è¯¯ï¼š</strong>${E(d.error || 'æœªçŸ¥é”™è¯¯')}<br><br><span style="color:var(--text3);font-size:12px">è¯·æ£€æŸ¥ AI ä»£ç†æœåŠ¡æ˜¯å¦åœ¨çº¿ï¼Œå¯ç‚¹å‡»é¡µé¢é¡¶éƒ¨ã€Œæ£€æµ‹ã€æŒ‰é’®ç¡®è®¤çŠ¶æ€ã€‚</span></div>`;
                    }
                }
            } catch (e) {
                console.error('è½®è¯¢æ‘˜è¦çŠ¶æ€å¤±è´¥:', e);
            }
        }

        async function loadSummaryHistory() {
            const el = document.getElementById('sum-history');
            if (!el) return;
            try {
                const r = await fetch('/api/summary/history?limit=10');
                const d = await r.json();
                const list = d.data || [];
                if (!list.length) {
                    el.innerHTML = '<div style="color:var(--text3);padding:12px;font-size:13px">æš‚æ— å†å²æ‘˜è¦è®°å½•</div>';
                    return;
                }
                el.innerHTML = list.map(s => {
                    const group = s.group_title || 'å…¨éƒ¨ç¾¤ç»„';
                    const start = BJ(s.period_start);
                    const end = BJ(s.period_end);
                    const cnt = s.message_count || 0;
                    const preview = (s.content || '').slice(0, 120).replace(/\n/g, ' ');
                    const id = 'hist-' + Math.random().toString(36).slice(2, 7);
                    return `<div style="border-bottom:1px solid var(--border);padding:12px 0" onclick="document.getElementById('${id}').style.display=document.getElementById('${id}').style.display==='none'?'':'none'" style="cursor:pointer">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;cursor:pointer">
                            <span style="font-size:13px;font-weight:600">ğŸ“Œ ${E(group)}</span>
                            <span style="font-size:11px;color:var(--text3)">${start} â†’ ${end}</span>
                        </div>
                        <div style="font-size:12px;color:var(--text3);margin-bottom:6px">ğŸ’¬ ${cnt.toLocaleString()} æ¡æ¶ˆæ¯</div>
                        <div style="font-size:12px;color:var(--text2);opacity:.8">${E(preview)}${s.content?.length > 120 ? '...' : ''}</div>
                        <div id="${id}" style="display:none;margin-top:10px;white-space:pre-wrap;font-size:12px;line-height:1.7;color:var(--text1);background:rgba(0,0,0,.2);padding:12px;border-radius:8px">${E(s.content || '')}</div>
                    </div>`;
                }).join('');
            } catch (e) {
                el.innerHTML = `<div style="color:#f87171;padding:12px;font-size:13px">åŠ è½½å¤±è´¥: ${E(e.message)}</div>`;
            }
        }

        function exportCSV() { window.open('/api/export?hours=24', '_blank') }

        // â”€â”€â”€ å…¨å±€åˆ·æ–° â”€â”€â”€
        async function refreshAll() {
            const active = document.querySelector('.page.active');
            if (!active) return;
            const id = active.id.replace('page-', '');
            showPage(id);
            // æ›´æ–°ä¾§è¾¹æ å®æ—¶çŠ¶æ€
            try {
                const r = await fetch('/api/health'); const d = await r.json();
                const now = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                document.getElementById('sidebar-stats').innerHTML = `ğŸ’¬ ${FN(d.messages)} æ¡ Â· ğŸ• ${now}`;
                document.getElementById('footer-status').textContent = d.status === 'ok' ? 'æ­£å¸¸è¿è¡Œ' : 'å¼‚å¸¸';
            } catch { document.getElementById('footer-status').textContent = 'è¿æ¥å¤±è´¥' }
        }

        // â”€â”€â”€ åˆå§‹åŒ– â”€â”€â”€
        showPage('overview');
        startAutoRefresh();
    </script>
</body>

</html>